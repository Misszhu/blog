### 流程

查询订单状态，待支付 ？ 显示订单待支付状态 ：显示订单支付成功 or 失败状态

### 出现的问题: 

首次进入，这个流程是没有问题的。但是当用户进入第三方的支付流程（云闪付、微信、支付宝），从第三方的支付成功 or 失败页，点击浏览器返回按钮，回到收银台页面，订单状态也无更新，还是待支付状态。

### 解决方式：

从进入页面开始，用setInterval重复查询订单支付状态接口，这样，从第三方的支付页面走了支付流程后返回收银台页，即使不刷新页面，setInterval也会定时查询接口，订单状态会及时更新。

### 又出现的问题：

setInterval重复查询订单支付状态接口，页面顶部会有一条进度条。也就是说，接口重复查询，进度条会一直闪烁，造成用户感知页面一直刷新的后果。

![image-20200310142740840](/Users/zhuhuiting/Library/Application Support/typora-user-images/image-20200310142740840.png)

### 另外两个问题

- 即使订单的状态变更为非待支付状态，订单状态的接口还在继续重复请求。
- 一开始的流程是进入页面先查询收银台信息，根据收银台信息接口返回的一些参数，再发起查询订单支付状态接口。由于发起查询状态接口之前没有判断参数是否为空。后来在mounted的钩子加上setInterval时，查询收银台信息的请求和查询订单状态的请求会先后发起，这时查询订单状态接口就会因为缺少参数导致报错，并且setInterval一直重复请求，报错就会重复提示，体验非常不好



### 解决方式

- [ ] 项目基于nuxt搭建，nuxt.config.js有nuxtConfig个对象，loading属性设为false即可隐藏请求接口时的进度条。
- [ ] 当查询订单支付状态接口返回订单非待支付状态时，用clearInterval清除定时器，避免浪费请求次数。
- [ ] 在请求订单查询状态接口之前，先判断必传的请求参数是否为空，不为空才走后面的请求。


### 琐碎的问题

UI提供的图的倒计时是时分秒的，进行开发的时候一厢情愿想着一般订单的支付超时时间都不会大于24小时，导致后面测试测某些支付时间大于24小时的订单，倒计时只显示了时分秒，没有显示天，倒计时时间错误。

后端返回的时间是时间戳，前端引用了`dayjs(NOW).format('YYYYMMDDHHmmss')`,格式化时间，一开始格式化模板用的是`YYYYMMDDhhmmss`,这个是错的，大写的字母H表示24小时制，小写的字母h表示12小时制。

开发的时没问清楚PC端是否做微信支付，看到接口返回的微信扫码支付只是自作主张过滤了（过滤的一部分原因也有h5 SDK没有做微信扫码支付）。导致到了提测准备上线的阶段，又额外在pc端新增了扫码支付。

收银台页面url上面有一个returnUrl，一开始测试的时候直接用了转码前的returnUrl，returnUrl的域名刚好和收银台url域名一样，导致kong指向错误。实际上，在当前页面有query参数是url时，记得要转码再拼上去。代码中拿到这个url也要先解码再拿来用。

还有一个低级错误，收银台页面没有手动设置标题，导致浏览器显示了`spaas-pc-checkout`这种标题。



接下来如何避免：

1. 不熟悉项目配置，这部分要找时间熟悉
2. 页面不断刷新，体验不好，没有考虑到用户体验问题
3. 业务流程考虑不周全
4. 需求了解不清晰，有侥幸心理

